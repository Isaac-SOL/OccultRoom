[gd_scene load_steps=47 format=3 uid="uid://cuughpl51whns"]

[ext_resource type="Script" path="res://scripts/General/main.gd" id="1_rshqp"]
[ext_resource type="PackedScene" uid="uid://cnmco5mvxbmif" path="res://scenes/room.tscn" id="1_vjk08"]
[ext_resource type="Script" path="res://scripts/camera_rotation.gd" id="2_xlx1h"]
[ext_resource type="AudioStream" uid="uid://cl7yx3m7c1yoq" path="res://assets/audio/Kenney/MagicShortLow.ogg" id="3_w5kr4"]
[ext_resource type="Script" path="res://scripts/room_camera.gd" id="4_j5ui4"]
[ext_resource type="AudioStream" uid="uid://05jkbyq3av5o" path="res://assets/audio/Kenney/Impacts/impactPlate_heavy_000.ogg" id="4_jbsch"]
[ext_resource type="Material" uid="uid://de7wyw0dv0jn6" path="res://shaders_mats/blur5x5.tres" id="5_tjfw7"]
[ext_resource type="AudioStream" uid="uid://biqq7cnkxqdik" path="res://assets/audio/Kenney/Impacts/impactPlate_heavy_001.ogg" id="5_vyq4l"]
[ext_resource type="Script" path="res://scripts/shaker.gd" id="6_gn2dp"]
[ext_resource type="Shader" path="res://shaders_mats/crystal_inner_shader.gdshader" id="6_hrxhi"]
[ext_resource type="PackedScene" uid="uid://bjdd44yp5226i" path="res://scenes/menus/pause_menu.tscn" id="6_o1hb0"]
[ext_resource type="Theme" uid="uid://ciwtpa400up3y" path="res://ui/in_game_theme.tres" id="6_o16yu"]
[ext_resource type="AudioStream" uid="uid://2drx2gf5p062" path="res://assets/audio/Kenney/Impacts/impactPlate_heavy_002.ogg" id="6_t04mm"]
[ext_resource type="AudioStream" uid="uid://bqwosq5rv0ea5" path="res://assets/audio/Kenney/Impacts/impactPlate_heavy_003.ogg" id="7_q3smn"]
[ext_resource type="AudioStream" uid="uid://eoer4nwxjqhl" path="res://assets/audio/Kenney/Impacts/impactPlate_heavy_004.ogg" id="8_h256d"]
[ext_resource type="Shader" uid="uid://02rsxnac7vv4" path="res://shaders_mats/noise_shader.tres" id="8_t2fxk"]
[ext_resource type="Texture2D" uid="uid://b5xp58v40peoi" path="res://assets/textures/look_around_hint.png" id="15_w5546"]
[ext_resource type="Texture2D" uid="uid://i3udstbqhgnw" path="res://assets/textures/pickup_hint.png" id="16_2d4bi"]
[ext_resource type="Texture2D" uid="uid://f4jlgk556d3i" path="res://assets/textures/free_turn_hint.png" id="17_legkf"]
[ext_resource type="Texture2D" uid="uid://dkcclecvpkvum" path="res://assets/textures/table_hint.png" id="18_tf8sk"]
[ext_resource type="Texture2D" uid="uid://bysc4u4i16e02" path="res://assets/textures/inspect_hint.png" id="19_4aftl"]
[ext_resource type="Texture2D" uid="uid://cvulckh5b7y0" path="res://assets/textures/turn_object_hint.png" id="20_srbnq"]

[sub_resource type="AudioStreamRandomizer" id="AudioStreamRandomizer_jo56l"]
streams_count = 5
stream_0/stream = ExtResource("4_jbsch")
stream_0/weight = 1.0
stream_1/stream = ExtResource("5_vyq4l")
stream_1/weight = 1.0
stream_2/stream = ExtResource("6_t04mm")
stream_2/weight = 1.0
stream_3/stream = ExtResource("7_q3smn")
stream_3/weight = 1.0
stream_4/stream = ExtResource("8_h256d")
stream_4/weight = 1.0

[sub_resource type="SphereMesh" id="SphereMesh_t3pin"]

[sub_resource type="StandardMaterial3D" id="StandardMaterial3D_nh86h"]
albedo_color = Color(0, 0, 0, 1)
emission_enabled = true
emission = Color(0.37791, 0.1482, 0.39, 1)

[sub_resource type="GDScript" id="GDScript_x1w2v"]
script/source = "extends Node3D

@onready var ball: Node3D = get_tree().get_first_node_in_group(\"CrystalBall\").get_node(\"VisionPosition\")

func _process(_delta):
	global_position = ball.global_position
	global_rotation = %Camera3D.global_rotation
	scale = ball.get_parent_node_3d().scale
"

[sub_resource type="ViewportTexture" id="ViewportTexture_hvdoy"]
viewport_path = NodePath("CrystalViewport")

[sub_resource type="Gradient" id="Gradient_1m5tx"]
offsets = PackedFloat32Array(0, 0.285714, 0.632653, 1)
colors = PackedColorArray(1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0.716049, 1, 1, 1, 0)

[sub_resource type="GradientTexture2D" id="GradientTexture2D_8wrkx"]
gradient = SubResource("Gradient_1m5tx")
width = 128
height = 128
fill = 1
fill_from = Vector2(0.5, 0.5)
fill_to = Vector2(0.5, 0)

[sub_resource type="ShaderMaterial" id="ShaderMaterial_m1u2t"]
resource_local_to_scene = true
render_priority = 0
shader = ExtResource("6_hrxhi")
shader_parameter/crystal_texture = SubResource("ViewportTexture_hvdoy")
shader_parameter/mask_texture = SubResource("GradientTexture2D_8wrkx")

[sub_resource type="PlaceholderTexture2D" id="PlaceholderTexture2D_juffk"]
size = Vector2(64, 64)

[sub_resource type="WorldBoundaryShape3D" id="WorldBoundaryShape3D_tkjhf"]
plane = Plane(0, 0, 1, 0)

[sub_resource type="PlaneMesh" id="PlaneMesh_2cvp0"]
size = Vector2(20, 20)
orientation = 2

[sub_resource type="Gradient" id="Gradient_cxhlg"]
offsets = PackedFloat32Array(0, 0.8159, 1)
colors = PackedColorArray(1, 1, 1, 0.196078, 1, 1, 1, 0.0237919, 1, 1, 1, 0)

[sub_resource type="GradientTexture2D" id="GradientTexture2D_aigiy"]
gradient = SubResource("Gradient_cxhlg")
width = 128
height = 128
fill = 1
fill_from = Vector2(0.5, 0.5)
fill_to = Vector2(0.5, 0)

[sub_resource type="GDScript" id="GDScript_kr5dd"]
script/source = "extends Sprite3D

@export var speed: float = 5

var target_scale: Vector3 = Vector3.ZERO

func _process(delta):
	scale = Util.decayv3(scale, target_scale, speed * delta)
"

[sub_resource type="GDScript" id="GDScript_x2obc"]
script/source = "extends Node3D

var target: Node3D

func _process(_delta):
	global_rotation = %CameraRotation.global_rotation
	if target:
		global_position = target.global_position
"

[sub_resource type="Environment" id="Environment_5x05i"]
background_mode = 1
ambient_light_source = 2
ambient_light_color = Color(0.73, 0, 0.73, 1)
ambient_light_energy = 2.0
reflected_light_source = 1

[sub_resource type="Gradient" id="Gradient_6w3gy"]
offsets = PackedFloat32Array(0, 0.117347, 0.352041, 0.520408, 0.77551, 0.928571, 1)
colors = PackedColorArray(0, 0, 0, 1, 0.117647, 1, 0.117647, 1, 1, 0, 0.352941, 1, 0.313726, 0.898039, 0.521569, 1, 1, 0, 0.776471, 1, 1, 1, 0, 1, 0, 0.454902, 1, 1)

[sub_resource type="FastNoiseLite" id="FastNoiseLite_mev52"]
noise_type = 0
frequency = 1.0
domain_warp_enabled = true

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_7otun"]
width = 64
height = 64
seamless = true
color_ramp = SubResource("Gradient_6w3gy")
noise = SubResource("FastNoiseLite_mev52")

[sub_resource type="ShaderMaterial" id="ShaderMaterial_46qlg"]
shader = ExtResource("8_t2fxk")
shader_parameter/Strength = 0.0
shader_parameter/Noise = SubResource("NoiseTexture2D_7otun")

[sub_resource type="Gradient" id="Gradient_p60u1"]
offsets = PackedFloat32Array(0, 0.25, 0.754386, 1)
colors = PackedColorArray(0, 0, 0, 0, 0, 0, 0, 0.784314, 0, 0, 0, 0.784314, 0, 0, 0, 0)

[sub_resource type="GradientTexture2D" id="GradientTexture2D_umxlv"]
gradient = SubResource("Gradient_p60u1")
fill_from = Vector2(0, 1)
fill_to = Vector2(0, 0)

[sub_resource type="LabelSettings" id="LabelSettings_nn5vu"]

[sub_resource type="GDScript" id="GDScript_hhhcl"]
script/source = "extends Label

@export_multiline var base_text: String
@export_multiline var inspect_text: String

func _ready():
	text = base_text

func set_inspect(inspect: bool):
	text = inspect_text if inspect else base_text
"

[node name="Main" type="Node3D" groups=["MainGroup"]]
script = ExtResource("1_rshqp")

[node name="Room" parent="." instance=ExtResource("1_vjk08")]
unique_name_in_owner = true
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, -4.5, 0, 4.5)

[node name="MagicAudio" type="AudioStreamPlayer" parent="."]
unique_name_in_owner = true
stream = ExtResource("3_w5kr4")
volume_db = -10.0

[node name="ShakeAudio" type="AudioStreamPlayer" parent="."]
unique_name_in_owner = true
stream = SubResource("AudioStreamRandomizer_jo56l")
volume_db = -5.0

[node name="Moon" type="MeshInstance3D" parent="."]
transform = Transform3D(0.493771, 0.626944, 0.602604, -0.397357, 0.779064, -0.484939, -0.773497, 2.98023e-08, 0.633799, 6.56214, -4.62451, 13.7876)
mesh = SubResource("SphereMesh_t3pin")
surface_material_override/0 = SubResource("StandardMaterial3D_nh86h")

[node name="CrystalSpritePivot" type="Node3D" parent="."]
transform = Transform3D(-0.707107, 0.353554, -0.612372, -5.96047e-08, 0.866025, 0.5, 0.707107, 0.353554, -0.612372, -9.38879, 9.59802, -9.38879)
script = SubResource("GDScript_x1w2v")

[node name="CrystalSprite" type="Sprite3D" parent="CrystalSpritePivot"]
unique_name_in_owner = true
transform = Transform3D(1, 5.96046e-08, 0, -1.78814e-07, 1, 1.93715e-07, -2.08616e-07, -1.19209e-07, 1, 0, 0, 0.4)
material_override = SubResource("ShaderMaterial_m1u2t")
billboard = 1
render_priority = 1
texture = SubResource("PlaceholderTexture2D_juffk")

[node name="CameraRotation" type="Node3D" parent="."]
unique_name_in_owner = true
transform = Transform3D(-0.707107, 0, -0.707107, 0, 1, 0, 0.707107, 0, -0.707107, 0, 0, 0)
script = ExtResource("2_xlx1h")

[node name="Shaker" type="Node3D" parent="CameraRotation"]
unique_name_in_owner = true
transform = Transform3D(1, -8.9407e-08, 2.68221e-07, -4.47035e-08, 0.866025, 0.5, -2.38419e-07, -0.5, 0.866025, 2.86102e-06, 11.732, 18.9739)
script = ExtResource("6_gn2dp")
shake_interval = 0.07
shake_factor = 2.0
move_speed = 10.0

[node name="Camera3D" type="Camera3D" parent="CameraRotation/Shaker"]
unique_name_in_owner = true
transform = Transform3D(1, -2.98023e-08, 0, 0, 1, 5.96046e-08, -5.96046e-08, -2.98023e-08, 1, 0, 0, 0)
projection = 1
size = 9.0
script = ExtResource("4_j5ui4")
ouija_size = 2.0

[node name="InspectPosition" type="Marker3D" parent="CameraRotation/Shaker/Camera3D"]
unique_name_in_owner = true
transform = Transform3D(-4.37114e-07, 2.38418e-07, -10, -4.05311e-06, 10, 2.38418e-07, 10, 4.05311e-06, -4.37114e-07, 0, 0, -6)

[node name="SpotLight3D" type="SpotLight3D" parent="CameraRotation/Shaker/Camera3D"]
spot_range = 10.0

[node name="SpotLight3D2" type="SpotLight3D" parent="CameraRotation/Shaker/Camera3D"]
transform = Transform3D(-1, 1.93715e-07, -3.57628e-07, 0, 0.866025, 0.5, 4.17233e-07, 0.5, -0.866025, -4.76837e-07, 2.83195, -10.2412)
spot_range = 10.0

[node name="BlockerArea" type="Area3D" parent="CameraRotation/Shaker/Camera3D"]
unique_name_in_owner = true
collision_layer = 8
collision_mask = 8
input_ray_pickable = false

[node name="CollisionShape3D" type="CollisionShape3D" parent="CameraRotation/Shaker/Camera3D/BlockerArea"]
transform = Transform3D(1, 0, 0, -2.98023e-08, 1, 0, -2.98023e-08, -2.98023e-08, 1, -9.53674e-07, -4.76837e-07, -12)
shape = SubResource("WorldBoundaryShape3D_tkjhf")

[node name="Blurrer" type="MeshInstance3D" parent="CameraRotation/Shaker/Camera3D"]
transform = Transform3D(1, 0, 0, 0, 1, -1.49012e-08, -2.98023e-08, -5.96046e-08, 1, -4.76837e-07, 0, -12)
visible = false
mesh = SubResource("PlaneMesh_2cvp0")
surface_material_override/0 = ExtResource("5_tjfw7")

[node name="HighlightSprite" type="Sprite3D" parent="CameraRotation/Shaker/Camera3D"]
unique_name_in_owner = true
transform = Transform3D(0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, -12)
texture = SubResource("GradientTexture2D_aigiy")
script = SubResource("GDScript_kr5dd")

[node name="CrystalViewport" type="SubViewport" parent="."]
unique_name_in_owner = true
size = Vector2i(128, 128)

[node name="CrystalTargetPosition" type="Node3D" parent="CrystalViewport"]
unique_name_in_owner = true
transform = Transform3D(-0.707107, 0, -0.707107, 0, 1, 0, 0.707107, 0, -0.707107, 0, 0, 0)
script = SubResource("GDScript_x2obc")

[node name="Camera3D" type="Camera3D" parent="CrystalViewport/CrystalTargetPosition"]
transform = Transform3D(1, -8.9407e-08, 2.68221e-07, -4.47035e-08, 0.866025, 0.5, -2.38419e-07, -0.5, 0.866025, 0, 5.732, 8.5816)
environment = SubResource("Environment_5x05i")
projection = 1
size = 3.0

[node name="ChangeVisionTimer" type="Timer" parent="CrystalViewport/CrystalTargetPosition"]
wait_time = 20.0
autostart = true

[node name="BackBufferCopy" type="BackBufferCopy" parent="."]
copy_mode = 2

[node name="PostProcessLayer" type="CanvasLayer" parent="."]

[node name="NoiseRect" type="ColorRect" parent="PostProcessLayer"]
unique_name_in_owner = true
material = SubResource("ShaderMaterial_46qlg")
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
mouse_filter = 2

[node name="UI" type="CanvasLayer" parent="."]

[node name="HintsContainer" type="VFlowContainer" parent="UI"]
anchors_preset = 11
anchor_left = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = -128.0
grow_horizontal = 0
grow_vertical = 2
alignment = 1

[node name="LookHint" type="TextureRect" parent="UI/HintsContainer"]
unique_name_in_owner = true
visible = false
layout_mode = 2
texture = ExtResource("15_w5546")

[node name="Panel" type="Panel" parent="UI/HintsContainer/LookHint"]
z_index = -1
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="PickupHint" type="TextureRect" parent="UI/HintsContainer"]
unique_name_in_owner = true
visible = false
layout_mode = 2
texture = ExtResource("16_2d4bi")

[node name="Panel" type="Panel" parent="UI/HintsContainer/PickupHint"]
z_index = -1
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="FreeTurnHint" type="TextureRect" parent="UI/HintsContainer"]
unique_name_in_owner = true
visible = false
layout_mode = 2
texture = ExtResource("17_legkf")

[node name="Panel" type="Panel" parent="UI/HintsContainer/FreeTurnHint"]
z_index = -1
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="TableHint" type="TextureRect" parent="UI/HintsContainer"]
unique_name_in_owner = true
visible = false
layout_mode = 2
texture = ExtResource("18_tf8sk")

[node name="Panel" type="Panel" parent="UI/HintsContainer/TableHint"]
z_index = -1
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="InspectHint" type="TextureRect" parent="UI/HintsContainer"]
unique_name_in_owner = true
visible = false
layout_mode = 2
texture = ExtResource("19_4aftl")

[node name="Panel" type="Panel" parent="UI/HintsContainer/InspectHint"]
z_index = -1
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="TurnHint" type="TextureRect" parent="UI/HintsContainer"]
unique_name_in_owner = true
visible = false
layout_mode = 2
texture = ExtResource("20_srbnq")

[node name="Panel" type="Panel" parent="UI/HintsContainer/TurnHint"]
z_index = -1
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="DialogControl" type="Control" parent="UI"]
unique_name_in_owner = true
visible = false
layout_mode = 3
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2

[node name="ClickPanel" type="Panel" parent="UI/DialogControl"]
modulate = Color(1, 1, 1, 0)
layout_mode = 1
anchors_preset = 15
anchor_right = 1.0
anchor_bottom = 1.0
grow_horizontal = 2
grow_vertical = 2
mouse_filter = 1

[node name="MarginContainer" type="MarginContainer" parent="UI/DialogControl"]
layout_mode = 1
anchors_preset = 12
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_top = -122.0
offset_bottom = -58.0
grow_horizontal = 2
grow_vertical = 0

[node name="TextureRect" type="TextureRect" parent="UI/DialogControl/MarginContainer"]
layout_mode = 2
texture = SubResource("GradientTexture2D_umxlv")

[node name="DialogText" type="Label" parent="UI/DialogControl/MarginContainer"]
unique_name_in_owner = true
layout_mode = 2
text = "Je connais bien ce genre d'esprit. Je vais jouer son jeu pour le moment."
label_settings = SubResource("LabelSettings_nn5vu")
horizontal_alignment = 1
vertical_alignment = 1

[node name="PauseLayer" type="CanvasLayer" parent="."]

[node name="PauseMenu" parent="PauseLayer" instance=ExtResource("6_o1hb0")]
unique_name_in_owner = true
visible = false

[node name="LabelLeft" type="Label" parent="PauseLayer/PauseMenu"]
unique_name_in_owner = true
layout_mode = 1
anchors_preset = 2
anchor_top = 1.0
anchor_bottom = 1.0
offset_top = -58.0
offset_right = 223.0
grow_vertical = 0
size_flags_horizontal = 0
size_flags_vertical = 8
theme = ExtResource("6_o16yu")
text = "Left / Right: Turn around
Space: Look at table"
vertical_alignment = 2
script = SubResource("GDScript_hhhcl")
base_text = "Left / Right: Turn around
Space: Look at table"
inspect_text = "Left / Right / Up / Down: Look"

[node name="LabelRight" type="Label" parent="PauseLayer/PauseMenu"]
unique_name_in_owner = true
layout_mode = 1
anchors_preset = 3
anchor_left = 1.0
anchor_top = 1.0
anchor_right = 1.0
anchor_bottom = 1.0
offset_left = -223.0
offset_top = -58.0
grow_horizontal = 0
grow_vertical = 0
size_flags_horizontal = 0
size_flags_vertical = 8
theme = ExtResource("6_o16yu")
text = "Mouse Left: Pick up / Put down
Mouse Right: Inspect
Mouse Wheel: Turn held object"
horizontal_alignment = 2
vertical_alignment = 2
script = SubResource("GDScript_hhhcl")
base_text = "Mouse Left: Pick up / Put down
Mouse Right: Inspect
Mouse Wheel: Turn held object"
inspect_text = "Mouse Left: Touch
Mouse Right: Put down"

[node name="LabelTopLeft" type="Label" parent="PauseLayer/PauseMenu"]
unique_name_in_owner = true
visible = false
modulate = Color(1, 1, 0, 1)
layout_mode = 0
offset_right = 223.0
offset_bottom = 58.0
size_flags_horizontal = 0
size_flags_vertical = 8
theme = ExtResource("6_o16yu")
text = "Objects left: 5"

[connection signal="object_placed" from="Room" to="." method="_on_room_object_placed"]
[connection signal="stool_just_placed" from="Room" to="." method="_on_room_stool_just_placed"]
[connection signal="timeout" from="CrystalViewport/CrystalTargetPosition/ChangeVisionTimer" to="." method="_on_change_vision_timer_timeout"]
[connection signal="gui_input" from="UI/DialogControl" to="." method="_on_dialog_control_gui_input"]
